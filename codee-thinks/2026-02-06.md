# Process Retrospective - February 6, 2026

**Coverage:** Feb 5-6, 2026 Discord activity (codee channel)  
**Primary Work:** PR #185 Document Image OCR, PR #181 Conversation Document Upload

---

## Friction Points Identified

### 1. Skipped Development Process
**Problem:** Codee went directly from question to plan to implementation, skipping the clarify and research phases. Carl caught it: *"You aren't following your process ðŸ˜„ You skipped clarify and research and went straight to plan."*

**Impact:** No PR created at feature start â†’ Carl couldn't follow along with progress. No research documentation for future reference.

**Proposed Solution:** Create a Claude Code command that enforces the process order.

**Implementation:**
```
File: .claude/commands/feature-start.md

# Feature Start Command

When starting any new feature:

1. **CLARIFY** (branch + PR created immediately)
   - Create feature branch
   - Create draft PR with checklist
   - Ask clarifying questions in PR description
   - BLOCK until questions answered

2. **RESEARCH** (documented in PR)
   - Investigate codebase patterns
   - Document findings in PR comments
   - Create research doc in thoughts/shared/research/

3. **PLAN** (committed to branch)
   - Create implementation plan
   - Get explicit approval before proceeding

4. **IMPLEMENT** (TDD mandatory)
   - Write failing test first
   - Make test pass
   - Refactor

Checklist for PR description:
- [ ] Clarify phase complete
- [ ] Research documented
- [ ] Plan approved
- [ ] Tests written before code
```

---

### 2. Binary Encoding Bugs Not Caught Until Production Testing
**Problem:** Image OCR implementation had UTF-8 encoding issues with binary data. Error: `invalid byte sequence in UTF-8`. Required multiple fix iterations.

**Impact:** ~30 minutes debugging encoding issues that could have been caught with proper test fixtures.

**Proposed Solution:** Add binary file test fixtures and encoding tests to the standard test checklist.

**Implementation:**
```ruby
# File: test/test_helper.rb (add to existing)

# Binary file test helpers
module BinaryTestHelpers
  def assert_binary_safe(string, message = nil)
    assert string.encoding == Encoding::BINARY || string.valid_encoding?,
           message || "String contains invalid encoding"
  end
  
  def binary_fixture(name)
    File.binread(Rails.root.join("test/fixtures/files/#{name}"))
  end
end

class ActiveSupport::TestCase
  include BinaryTestHelpers
end
```

```markdown
# File: .claude/commands/add-file-processing.md

When adding file processing features:

1. Always use binary mode for file reads: `File.binread(path)`
2. Force binary encoding on byte strings: `data.force_encoding(Encoding::BINARY)`
3. Write encoding tests:
   - Test with valid UTF-8 files
   - Test with binary files (images, PDFs)
   - Test with mixed-encoding files
4. Add test fixtures to test/fixtures/files/
```

---

### 3. Widget Delete vs Show Page Delete Confusion
**Problem:** Delete buttons needed different behaviors based on context:
- Widget delete â†’ Turbo Stream removal (stay on page)
- Show page delete â†’ HTML redirect (navigate away)

Initially used same controller action with `respond_to` blocks, causing confusion.

**Impact:** ~15 minutes discussing architecture, tests needed to be added retroactively.

**Proposed Solution:** Document the Dashboard namespace pattern for widget actions.

**Implementation:**
```markdown
# File: .claude/commands/add-widget-action.md

When adding actions that appear in both widgets and full pages:

**Pattern: Dashboard Namespace**

Widget actions go in `Dashboard::` namespace:
- `Dashboard::FilesController#destroy` â†’ turbo_stream
- `Dashboard::ConversationsController#destroy` â†’ turbo_stream

Full page actions stay in standard controllers:
- `FilesController#destroy` â†’ HTML redirect
- `ConversationsController#destroy` â†’ HTML redirect

Routes:
```ruby
namespace :dashboard do
  resources :files, only: [:destroy]
  resources :conversations, only: [:destroy]
end
```

This avoids format sniffing and keeps single responsibility per action.
```

---

### 4. Test Naming Convention for External Tests
**Problem:** Integration tests that call real APIs shouldn't run in normal test suite. Discussion about naming convention.

**Impact:** Minor - 5 minutes clarifying. But could cause CI failures if forgotten.

**Proposed Solution:** Document the convention in AGENTS.md or a command.

**Implementation:**
```markdown
# File: .claude/commands/add-external-test.md

For tests that call external services (APIs, LLMs, etc.):

1. Place in `test/external/` directory
2. Name with `test_` prefix: `test_image_ocr_integration.rb`
   - Rails pattern is `*_test.rb` suffix
   - `test_*.rb` prefix is NOT matched by `bin/rails test`
   
3. Add README to test/external/:
```markdown
# External Tests

Tests that call real external services. Not run in CI.

## Running
```bash
bin/rails test test/external/           # All external tests
bin/rails test test/external/test_*.rb  # Specific test
```
```

4. Document in test file header:
```ruby
# External test - not run in normal test suite
# Run manually: bin/rails test test/external/test_image_ocr_integration.rb
```
```

---

### 5. Rate Limiting During Development
**Problem:** Hit `HTTP 429: rate_limit_error` from Anthropic during active development session.

**Impact:** Brief interruption, but could block critical work.

**Proposed Solution:** No code change needed - this is awareness for cost/rate planning. Consider adding rate limit handling to sub-agents.

---

### 6. Spinner Bug (expects_response metadata)
**Problem:** Upload notification message had `role: "user"` which triggered the AI thinking spinner, even though no response was expected.

**Impact:** ~15 minutes to diagnose and fix. User confusion.

**Proposed Solution:** Already fixed with `metadata: { expects_response: false }`. Document pattern for future use.

**Implementation:**
```markdown
# File: thoughts/shared/patterns/system-messages.md

## System Messages That Don't Expect AI Response

When creating automated messages (upload notifications, system events):

```ruby
Message.create!(
  conversation: conversation,
  role: "user",  # or "system" if appropriate
  content: "File uploaded: #{filename}",
  metadata: { expects_response: false }
)
```

View check:
```erb
<% if message.role == "user" && message.metadata&.dig("expects_response") != false %>
  <%= render "thinking_spinner" %>
<% end %>
```
```

---

## Successful Patterns Worth Codifying

### 1. Sub-Agent Delegation for Complex Fixes
**What Worked:** Binary encoding fix was properly delegated to a sub-agent with clear scope: "investigate where the AI analysis is incorrectly being saved... Will report back with the fix (won't push until you review)."

**Codify:** This is already good practice. Keep using sub-agents for:
- Debugging complex issues
- Parallel investigation
- Implementation after plan approval

### 2. Test-First Catch-Up
**What Worked:** After Carl's reminder about TDD, tests were added properly. Controller tests verified both turbo_stream and HTML behaviors.

**Codify:** Already in process docs. Key lesson: even when moving fast, pause to write tests.

### 3. Clean Controller Separation
**What Worked:** Dashboard namespace pattern is clean and follows 37signals conventions.

**Codify:** Document as standard pattern (see Implementation above).

---

## Priority Improvements

### High Priority (implement this week)
1. **feature-start.md command** - Enforces process order, prevents skipping phases
2. **add-external-test.md command** - Documents test/external/ convention

### Medium Priority
3. **Binary encoding test helpers** - Add to test_helper.rb
4. **System message pattern doc** - Document expects_response metadata

### Low Priority (document for reference)
5. **Dashboard namespace pattern** - Already implemented, just needs docs

---

## Metrics

- **Total PRs worked:** 2 (PR #181, PR #185)
- **Bugs found during testing:** 4 (encoding, spinner, file list, delete redirect)
- **Process violations caught by Carl:** 1 (skipped clarify/research)
- **Time lost to debugging:** ~1 hour (encoding issues primarily)

---

*Generated by Codee's daily retrospective cron job*

# Process Retrospective - February 3, 2026

Analysis of 24 hours of Discord chat (Feb 2-3, 2026)

---

## 1. Wasted Effort: DOCX-to-LLM Integration

### Problem
Significant time spent implementing DOCX file attachment to send original Word documents to LLM instead of extracted markdown. Created worktree, wrote code, resolved merge conflicts—only to discover **OpenAI doesn't support DOCX files via their API**.

This should have been caught in 5 minutes of research before writing any code.

### Proposed Solution
Create a **pre-implementation research command** that validates API capabilities before coding begins.

### Implementation
Create `.claude/commands/pre_flight.md`:

```markdown
# Pre-Flight Check

Before implementing any LLM or API integration, verify:

1. **File format support** - Check API docs for supported file types
2. **Rate limits** - Understand quotas and throttling
3. **Cost implications** - Estimate token/API costs
4. **Existing patterns** - Check if codebase already handles this

## Research Steps
1. Search official API documentation
2. Test with minimal curl/script before full implementation
3. Document findings in PR description

## Output
Write a brief "Pre-Flight Report" before starting implementation:
- Supported: yes/no
- Fallback approach if not supported
- Estimated complexity
```

---

## 2. Rubocop CI/Local Mismatch

### Problem
Multiple CI failures for Rubocop issues (trailing whitespace, array brackets, heredoc syntax) that **didn't appear in local runs**. Root cause: different Ruby versions between local (system Ruby) and CI (Ruby 3.4 via rbenv).

> "When I run rubocop locally I don't get any errors... Github is showing invalid comma"

### Proposed Solution
Create a **Rubocop sync command** that ensures local environment matches CI.

### Implementation
Create `.claude/commands/lint_sync.md`:

```markdown
# Lint Sync

Ensure local linting matches CI environment.

## Steps
1. Check `.ruby-version` file and switch: `rbenv local $(cat .ruby-version)`
2. Run Rubocop with same command as CI: `bundle exec rubocop`
3. Auto-fix correctable issues: `bundle exec rubocop -a`
4. If issues persist, check CI workflow for exact command

## Pre-Push Checklist
- [ ] Ruby version matches `.ruby-version`
- [ ] `bundle exec rubocop` passes
- [ ] `bundle exec rails test` passes
```

---

## 3. Orphaned Worktrees After Merge

### Problem
Multiple worktrees exist for branches that have been merged:
- `llapp-gen-timing` → feature/generation-timing (merged)
- `llapp-parallel` → feature/parallel-reteach (merged)
- `llapp-token-opt` → feature/token-optimization (merged)

These consume disk space and create confusion about what's active.

### Proposed Solution
Create a **worktree cleanup command**.

### Implementation
Create `.claude/commands/cleanup_worktrees.md`:

```markdown
# Cleanup Worktrees

Remove worktrees for branches that have been merged to main.

## Steps
1. List all worktrees: `git worktree list`
2. For each worktree, check if branch is merged: `git branch --merged main | grep <branch>`
3. If merged, remove: `git worktree remove <path> --force`
4. Delete local branch: `git branch -d <branch>`

## Script
```bash
#!/bin/bash
for worktree in $(git worktree list --porcelain | grep "^worktree" | cut -d' ' -f2 | tail -n +2); do
  branch=$(git -C "$worktree" branch --show-current)
  if git branch --merged main | grep -q "$branch"; then
    echo "Removing merged worktree: $worktree ($branch)"
    git worktree remove "$worktree" --force
    git branch -d "$branch" 2>/dev/null
  fi
done
```
```

---

## 4. SolidQueue Debugging Friction

### Problem
When jobs failed, debugging required multiple manual Rails console queries to find the error:

```ruby
SolidQueue::Job.where(class_name: "GenerateWdmProductsJob").order(created_at: :desc).first
job.failed_execution&.error
```

This was done repeatedly during the session.

### Proposed Solution
Create a **job debugging command**.

### Implementation
Create `.claude/commands/debug_jobs.md`:

```markdown
# Debug Jobs

Quick diagnostics for SolidQueue job failures.

## Commands

### Recent failures
```ruby
SolidQueue::FailedExecution.order(created_at: :desc).limit(5).each do |f|
  job = f.job
  puts "#{job.class_name} @ #{f.created_at}"
  puts "  Args: #{job.arguments['arguments']&.first}"
  puts "  Error: #{f.error&.first(200)}"
  puts
end
```

### Find job by class
```ruby
def find_job(class_name)
  SolidQueue::Job.where(class_name: class_name).order(created_at: :desc).first
end
```

### Retry failed job
```ruby
def retry_job(job_id)
  SolidQueue::FailedExecution.find_by(job_id: job_id)&.retry
end
```

## Usage
Run `bin/rails runner 'load "scripts/debug_jobs.rb"'` or paste into console.
```

---

## 5. UI Changes Without Design Approval

### Problem
Implemented trash can delete functionality for plannings, but result was "terrible" and had to be fully reverted. Quote: "Roll back all of the delete work."

### Proposed Solution
Add a **design checkpoint** to the vibe2win workflow for UI changes.

### Implementation
Update `.claude/commands/vibe2win.md` to include:

```markdown
## UI Change Checkpoint

For any user-visible changes:

1. **Before coding**: Describe the proposed UI change in chat
2. **Get explicit approval**: Wait for "looks good" or similar
3. **Reference existing patterns**: "Follow the style we have used elsewhere" is not enough—screenshot or link to the specific component
4. **Small PRs**: UI changes should be isolated, easy to revert

If requirements are unclear, ask:
- "Should this be a button or an icon?"
- "What color/style matches existing patterns?"
- "Should there be a confirmation dialog?"
```

---

## 6. Environment Variable Sync for LaunchAgents

### Problem
Worker LaunchAgent was missing `OPENAI_API_KEY`, causing all jobs to fail with "Missing configuration for OpenAI". Had to manually add it to the plist and restart.

### Proposed Solution
Document required environment variables and create a validation script.

### Implementation
Add to `TOOLS.md` or create `scripts/validate_env.rb`:

```ruby
# scripts/validate_env.rb
REQUIRED_VARS = %w[
  OPENAI_API_KEY
  DATABASE_URL
  REDIS_URL
  SECRET_KEY_BASE
]

missing = REQUIRED_VARS.select { |var| ENV[var].nil? || ENV[var].empty? }

if missing.any?
  puts "❌ Missing environment variables:"
  missing.each { |var| puts "   - #{var}" }
  exit 1
else
  puts "✅ All required environment variables present"
end
```

Add to LaunchAgent startup or run manually after config changes.

---

## Summary

| # | Problem | Solution | Priority |
|---|---------|----------|----------|
| 1 | DOCX-to-LLM wasted effort | Pre-flight research command | High |
| 2 | Rubocop CI/local mismatch | Lint sync command | High |
| 3 | Orphaned worktrees | Cleanup command | Medium |
| 4 | SolidQueue debugging | Debug jobs command | Medium |
| 5 | UI changes without approval | Design checkpoint in vibe2win | High |
| 6 | Missing env vars in LaunchAgents | Validation script | Medium |

---

## Key Learning Reinforced

> **"ALL coding gets delegated to sub-agents. No exceptions."**

This rule was explicitly established during this session. Even "quick fixes" should be delegated. The coordinator role is: decide, delegate, communicate—not code.
